# TCP/IP Networking
- **TCP/IP (Transmission Control Protocol/Internet Protocol)** is the networking system that underlies the Internet. TCP/IP does not depend on any particular hardware or operating system, so devices that speak TCP/IP can all exchange data despite their many differences.
- TCP/IP works on networks of any size or topology, even when they are not connected to the outside world.

## TCP/IP and its relationship to the Internet
### Network Standards and documentation
- The technical activities of the Internet community are summarized in documents known as Requests for Comments or RFCs.
  - These are comprised of Protocol standards, proposed changes, and informational bulletins.
  - These start as Internet Drafts and then either die or are promoted to the RFC series.
  - These are numbered sequentially, but also come with descriptive sub-titles but are formally cited by their number.
  - Once distributed the contents of an RFC are never changed.

## Networking Basics
- **TCP/IP** is a protocol "suite," meaning a set of network protocols designed to work smoothly together. It includes several components, each defined by a standards-track RFC or a series of RFCs:
  - **IP - Internet Protocol** - routes data packets from one machine to another (RFC791).
  - **ICMP - Internet Control Message Protocol** - defines several kinds of low-level support for IP, including error messages, routing assistance, and debugging help (RFC792).
  - **ARP - Address Resolution Protocol** - translates IP addresses to hardware addresses (RFC826).
  - **UDP  - User Datagram Protocol** - implements unverified, one way data delivery (RFC768).
  - **TCP  - Transmission Control Protocol** - implements reliable, full duplex, flow-controlled, error-corrected conversations (RFC793).
- These protocols are arranged in a hierarchy or "stack," with the higher-level protocols making use of the protocols beneath them. TCP/IP is conventionally described as a five-layer system, but the actual TCP/IP protocols inhabit only three of these layers.
- There is a good TCP/IP layering model diagram on **page 379**, I tried to re-create it but it wasn't legible
- We are technically out of IPv4 address space. But everything is still OK because of the following technologies:
  - **Network Address Translation (NAT)** - Allows entire networks of machines to hide behind a single IPv4 address.
  - **Classless Inter-Domain Routing (CIDR)** - Flexibly subdivides networks and promotes efficient back-bone routing
- Contention of IPv4 address is still an issue, but this tends to be reallocated in economic rather than technological ways nowadays.
- The underlying issue limiting IPv6's adoption is that IPv4 support is still mandatory for a device to be a functional citizen of the Internet (as of 2017).

### Packets and encapsulation
- TCP/IP supports a variety of physical networks and transport systems, these include:
  - Ethernet, token ring, MPLS (Multiprotocol Label Switching), wireless Ethernet, and serial-line-based systems. 
- Hardware is managed within the link layer of the TCP/IP architecture, and **higher-level protocols do not know or care about specific hardware being used**
- **Packets core properties:**
  - Data travels on a network in the form of packets, which are bursts of data with a maximum length imposed by the link layer.
  - Each packet consists of a header and a payload.
	- The header tells the packet where the packet came from and where it's going. It can also include checksums, protocol-specific information, or other handling instructions.
	- The payload is the data to be transferred.
- The name of the primitive data unit depends on the layer of the protocol (although you can get away with calling all of these a "packet" as a generic term in most situations).
  - **TCP layer - a segment**
  - **IP layer - a packet**
  - **Link layer - a frame**

#### Encapsulation
- As a packet travels down the protocol stack (from TCP or UDP transport to IP to Ethernet to the physical wire) in preparation for being sent, each protocol adds its own header information. 
- **Each protocol's finished packet becomes the payload part of the packet generated by the next protocol.** This is known as **encapsulation**.
- On the receiving machine, the encapsulation is reversed as the packet travels back up the protocol stack.

### Ethernet framing
- One of the main tasks of the link layer is to add headers to packets and to put separators between them, this process is known as **framing**. The headers contain each packet's link-layer addressing information and checksums, the separators ensure that receivers can tell where one packet stops and the next one begins.
- The link layer is divided into two parts: 
  - **MAC, the Media Access Control sublayer** - deals with the media and transmits packets onto the wire.
  - **LLC, the Logical Link Control sublayer** - handles the framing

## Packet Addressing
- Several addressing schemes are used in combination:
  - **MAC (Media Access Control)** addresses for use by hardware
  - **IPv4 and IPv6** - addresses used for use by software
  - **Hostnames** - for use by people

### Hardware (MAC) addressing
- **Each of a host's network interfaces usually has one link-layer MAC address that distinguishes it from other machines on the physical network, in addition to one or more IP addresses that identify the interface on the global Internet.**
  - **IP addresses identify _network interfaces, not machines_**
- The lowest level of addressing is dictated by network hardware.
  - Ethernet devices are assigned a unique 6-byte hardware address at the time of manufacture. These are traditionally written as a series of 2-digit hex bytes separated by colons; for example, `00:50:8d:9a:3b:df`
- Token ring interfaces have a similar address that is also six bytes long.
- A 6-byte Ethernet address is divided into two parts:
  - The first three bytes identify the manufacturer of the hardware. These are actually IEEE Organizationally Unique Identifiers (OUIs) that can be looked up directly on the IEEE's database.
  - The last three bytes are a unique serial number that the manufacturer assigns.
- In theory, Ethernet hardware addresses are permanently assigned and immutable. However, many network interfaces let you override the hardware address and set one of your own choosing. This can be handy if you need to replace a broken machine or network card and for some reason must use the old MAC address. But for simplicity its generally preferable to preserve the uniqueness of MAC addresses.

### IP addressing
- **IP addressing** can sometimes be referred to as **Internet addressing**.
- **IP addresses** are hardware independent. **Within any particular network context, an IP address identifies a specific and unique destination.**
  - Although it is not quite accurate to say that IP addresses are globally unique because several special cases muddy the water:
	- NAT uses one interface's IP address to handle traffic for multiple machines.
	- IP private address spaces are addresses that multiple sites can use at once, as long as the addresses are not visible to the Internet.
	- Anycast addressing shares one IP address among several machines.
- **The mapping from IP addresses to hardware addresses is implemented at the link layer of the TCP/IP model.** 
  - On networks such as Ethernet that support broadcasting (that is, networks that allow packets to be addressed to "all hosts on this physical network"), senders use the ARP protocol to discover mappings without assistance from a system administrator.
  - In IPv6, an interface's MAC address is often used as part of the IP address, making the translation between IP and hardware addressing virtually automatic.

### Hostname "addressing"
- IP addresses are sequences of numbers, so they are hard for people to remember.
- Operating systems allow one or more hostnames to be associated with an IP address. This allows users users to be able to type `rfc-editor.org` instead of `4.31.198.491`.
- The hostname mapping can be setup in several ways, from using the static `/etc/hosts` file, to the LDAP database system, to DNS, the world-wide Domain Name System.
- **Hostnames are really just convenient shorthand for IP addresses, and as such, they refer to network interfaces rather than computers.**

### Ports
- IP addresses identify machine's network interfaces, but they are not specific enough to address individual processes or services, many of which might be actively using the network at once. TCP and UDP extend IP address with a concept know as a port.
- **Port** - a 16-bit number that supplements the IP address to specify a particular communication channel. Valid ports range from 1-65535
- Standard services such as SMTP, SSH, and HTTP associate themselves with "well known" ports that are defined in `/etc/services`
  - This file is part of the infrastructure and you should never need to modify it. Although you can if you want to add a non-standard service.
- TCP and UDP have ports that have the same sets of potential values, **despite this the port spaces are entirely separate and unrelated.** Thus, firewalls must be configured separately for each of these protocols.
- To prevent impersonation of system services UNIX systems restrict programs from binding to port numbers under 1,024 unless they are run as root or have an appropriate Linux capability. This restriction only applies to internal processes though, anyone can communicate with a server running on a low port number.
  - This is actually mostly a nuisance nowadays though, it is often more secure to run standard services on unprivileged ports as nonroot users and to forward network traffic to these high-numbered ports through a load balancer or some other type of network appliance.

### Address types
- The IP layer defines several broad types of address, some of which have direct counterparts at the link layer.
  - **Unicast** - addresses that refer to a single network interface.
  - **Multicast** - addresses that simultaneously target a group of hosts.
  - **Broadcast** - addresses that include all hosts on the local subnet.
  - **Anycast** - addresses that resolve to any one of a group of hosts.
	- This is largely unused on today's Internet, but it's slightly more popular with IPv6. IPv6 broadcast addresses are really just specialized forms of multicast addressing.
	- Anycast addresses bring load balancing to the network layer by allowing packets to be delivered to whichever of several destinations is closest in terms of network routing.

## IP Addresses
- With the exception of multicast addresses, **Internet addresses consist of a network portion and a host portion**
  - The network portion identifies a logical network to which the address refers.
  - The host portion identifies a node on that network.
- IPv4 
  - Addresses are 4 bytes long and the boundary between network and host portions is set administratively.
  - Written as decimal numbers, one for each byte, separated by periods; for example 209.85.171.147. The leftmost byte is the most significant and is always part of the network portion.
  - When 127 is the first byte it denotes the "loopback network" 
	- This is a fictitious network that has no real hardware interface and only one host.
	- **The loopback address 127.0.0.1 always refers to the current host.** Its symbolic name is "localhost"
- IPv6 
  - Addresses are 16 bytes long and the network portion and host portion are always 8 bytes each.
  - IPv6 addresses and their text-formatted equivalents are a bit more complicated. You can find details about them on page 394.

## Routing
- **Routing** is the process of directing a packet through the maze of networks that stand between its source and its destination.
- Routing information takes the form of rules ("routes"), such as "To reach network A, send packets through machine C." There can also be a default route that tells what to do with packets bound for a network to which no explicit route exists.
- Routing information is stored in a table in the kernel. 
  - Each table entry has several parameters, including a mask for each listed network.
  - To route a packet to a particular address, the kernel picks the most specific of the matching routes - that is the one with the longest mask.
  - **If the kernel finds no relevant route and no default route, it returns a "network unreachable" ICMP error to the sender.**
- "Routing" is commonly used to mean two distinct things:
  - Looking up a network address in the routing table as part of the process of forwarding a packet towards its destination.
  - Building the routing table in the first place.

### Routing tables
- You can view a machine's routing table with `ip route show`
- An entry's gateway field must contain the full IP address of a local network interface or adjacent host; on Linux kernels it can be 0.0.0.0 to invoke the default gateway.
- **A host can route packets only to gateway machines that are reachable through a directly connected network.** The local host's job is limited to moving packets one hop closer to their destinations, so it is pointless to include information about nonadjacent gateways in the local routing table.
- Routing tables can be configured statically, dynamically, or with a combination of both.
  - Static routes remain in the routing table as long as the system is up. 
	- They are often set at boot time from one of the system startup scripts.
	- A static route can be entered explicitly with the `ip` command. 
	- Most machines on a local area network have only one way to get out to the rest of the network, so the routing problem is easy. A default route added at boot time suffices to point towards the way out.
  - Dynamic routes are required on more complicated network topologies.
	- Dynamic routing is implemented by a daemon process that maintains and modifies the routing table. This daemon communicates with daemons on different hosts to discover the topology of the network and to figure out how to reach distant networks. There are several different daemons available to preform this task.

## DHCP: The Dynamic Host Configuration Protocol
- When you plug a device or computer into a network, it usually obtains an IP address for itself on the local network, sets up an appropriate default route, and connects itself to a local DNS server. **The Dynamic Host Configuration Protocol (DHCP)** is what makes this possible.
- DHCP lets a DHCP client "lease" a variety of network and administrative parameters from a central server that is authorize to distribute them.
- Leasable parameters include:
  - IP addresses and netmasks
  - Gateways (default routes)
  - DNS name servers
  - Syslog hosts
  - WINS servers, X font servers, proxy servers, NTP servers.
  - TFTP servers (for loading a boot image)
- Clients must report back to the DHCP server periodically to renew their leases. 
  - If a lease is not renewed it will eventually expire, making it free to be reassigned by the DHCP server.
  - The lease period is configurable, but it is typically quite long (hours or days).

## Basic Network Configuration
- Here is the process to add a new machine to a local network:
  - Assign a unique IP address and hostname
  - Configure network interfaces and IP addresses
  - Set up a default route and perhaps fancier routing.
  - Point to a DNS name server to allow access to the rest of the Internet.
- If you rely on DHCP for basic provisioning, most of the configuration chores for a new machine are performed on the DHCP server rather than a new machine itself.
- **After making any change that might affect startup, always reboot to verify that the machine comes back up correctly.** This will save you if 6 months later when the power failed and the machine isn't booting and you have no idea why.

### DNS configuration
- **DNS configuration** is set in the `/etc/resolv.conf` file.
  - This file lists the DNS domains that should be searched to resolve names that are incomplete and the IP address of the name servers to contact for name lookups.
  - This should list the "closest" stable name server first as the servers are contacted in order.

